import numpy as np


class A:
    def __init__(self):
        self.instruction_template_ids = [151644, 872, 198]
        self.response_template_ids = [151644, 77091, 198]

    def a(self,):
        response_ids = [2, 5512, 11, 582, 1184, 311, 17179, 279, 3552, 369, 279, 40537, 2692, 13, 1205, 3278, 990, 279, 1565, 3445, 13500, 10122, 82, 63, 5333, 1714, 624,
        3833, 9655, 284, 97723, 38677, 31396, 5460, 13500, 10122, 82, 2822, 2, 22826, 279, 3552, 504, 279, 2033, 624, 87388, 10122, 284, 3552, 9655, 58, 15, 5352, 3833, 15674, 2, 4695, 11, 582, 1184, 311, 2506, 5619, 279, 3681, 5492, 389, 40537, 3080, 582, 5545, 264, 5492, 553, 59455, 26691, 624, 3231, 57102, 284, 2240, 198, 3472, 3007, 510, 262, 671, 2126, 279, 1482, 5492, 2265,
        624, 262, 1482, 57102, 6112, 284, 97723, 76453, 4952, 28545, 38615, 1203, 4181, 606, 4432, 1066, 262, 671, 4248, 421, 279, 1482, 5492, 374, 553, 59455, 26691, 624, 262, 421, 1482, 57102,
        6112, 18073, 368, 961, 364, 68658, 36843, 3646, 286, 671, 7054, 279, 3681, 3754, 624, 286, 97723, 76453, 38925, 28545, 741, 1789, 286, 671, 5549, 279, 1482, 5492, 3890, 624, 286, 1482, 57102, 284, 1482, 57102, 6112, 7213, 262, 770, 510, 286, 1438, 271, 2, 8213, 279, 1590, 5492, 2265, 624, 11822, 57102, 6112, 284, 1482, 57102, 198, 1350, 955, 10022, 1590, 5492, 6342, 572,
        11573, 11822, 57102, 6112, 11661, 899, 151645, 198, 151644, 872, 198, 20294, 4641, 13, 27163, 1419, 510, 220, 2887, 4055, 12669, 13933, 21156, 1555, 220, 16, 16, 11, 304, 366, 4352, 397,
        262, 1482, 57102, 6112, 284, 97723, 76453, 4952, 28545, 38615, 1203, 4181, 606, 4432, 5108, 6306, 61724, 61724, 61724, 61724, 61724, 61724, 61, 198, 1354, 25, 2308, 5333, 6941, 364, 3231
        , 28545, 6, 1730, 304, 279, 87790, 906, 13, 151645, 198, 151644, 77091, 198, 2132, 4977, 429, 279, 1565, 3231, 28545, 63, 729, 1558, 537, 3000, 304, 279, 40537, 5333, 13, 12090, 11, 582,646, 990, 279, 1565, 3600, 28545, 63, 729, 311, 1486, 279, 1790, 3754, 1283, 42659, 279, 1482, 825, 13, 5692, 594, 1246, 582, 646, 5602, 279, 2038, 311, 11075, 279, 12685, 14944, 1447, 73594, 12669, 198, 474, 97723, 271, 2, 31562, 279, 3552, 369, 279, 40537, 2692, 624, 3833, 9655, 284, 97723, 38677, 31396, 5460, 13500, 10122, 82, 741, 87388, 10122, 284, 3552, 9655, 58, 15
        , 5352, 3833, 15674, 2, 13655, 5619, 279, 3681, 5492, 389, 40537, 3080, 582, 5545, 264, 5492, 553, 59455, 26691, 624, 3231, 57102, 284, 2240, 198, 3472, 3007, 510, 262, 671, 25784, 279, 1482, 3754, 624, 262, 97723, 76453, 4529, 28545, 741, 1066, 262, 671, 2126, 279, 1482, 5492, 2265, 624, 262, 1482, 57102, 6112, 284, 97723, 76453, 4952, 28545, 38615, 1203, 4181, 606, 4432
        , 1066, 262, 671, 4248, 421, 279, 1482, 5492, 374, 553, 59455, 26691, 624, 262, 421, 1482, 57102, 6112, 18073, 368, 961, 364, 68658, 36843, 3646, 286, 671, 7054, 279, 3681, 3754, 624, 286
        , 97723, 76453, 38925, 28545, 741, 1789, 286, 671, 5549, 279, 1482, 5492, 3890, 624, 286, 1482, 57102, 284, 1482, 57102, 6112, 7213, 262, 770, 510, 286, 1438, 271, 2, 8213, 279, 1590, 5492, 2265, 624, 11822, 57102, 6112, 284, 1482, 57102, 198, 1350, 955, 10022, 1590, 5492, 6342, 572, 11573, 11822, 57102, 6112, 11661, 1138, 13874, 19324, 1986, 10807, 2038, 5711, 279, 1565,
        3600, 28545, 63, 729, 4518, 315, 1565, 3231, 28545, 7808, 10693, 601, 311, 1486, 279, 1790, 3754, 1283, 42659, 279, 1482, 825, 13, 151645, 198, 151644, 872, 198, 20294, 4641, 13, 27163,
        1419, 510, 33890, 1465, 304, 1555, 510, 2132, 4977, 429, 279, 1565, 3231, 28545, 63, 729, 1558, 537, 3000, 304, 279, 40537, 5333, 13, 12090, 11, 582, 646, 990, 279, 1565, 3600, 28545, 63,
        729, 311, 1486, 279, 1790, 3754, 1283, 42659, 279, 1482, 825, 13, 5692, 594, 1246, 582, 646, 5602, 279, 2038, 311, 11075, 279, 12685, 14944, 510, 2052, 25, 21506, 51199, 914, 23141, 320,
        19285, 1569, 518, 1555, 220, 16, 8, 151645, 198, 151644, 77091, 198, 785, 4265, 47182, 1576, 279, 1565, 3231, 28545, 63, 729, 374, 537, 4512, 304, 279, 40537, 5333, 9705, 13, 12090, 11,
        582, 646, 990, 279, 1565, 3600, 28545, 63, 729, 311, 1486, 279, 1790, 3754, 1283, 42659, 279, 1482, 825, 13, 5692, 748, 1246, 582, 646, 5602, 279, 2038, 311, 11075, 279, 12685, 14944, 1447, 73594, 12669, 198, 474, 97723, 271, 2, 31562, 279, 3552, 369, 279, 40537, 2692, 624, 3833, 9655, 284, 97723, 38677, 31396, 5460, 13500, 10122, 82, 741, 87388, 10122, 284, 3552, 9655, 58, 15, 5352, 3833, 15674, 2, 13655, 5619, 279, 3681, 5492, 389, 40537, 3080, 582, 5545, 264, 5492, 553, 59455, 26691, 624, 3231, 57102, 284, 2240, 198, 3472, 3007, 510, 262, 671, 25784, 279, 1482, 3754, 624, 262, 97723, 76453, 4529, 28545, 741, 1066, 262, 671, 2126, 279, 1482, 5492, 2265, 624, 262, 1482, 57102, 6112, 284, 97723, 76453, 4952, 28545, 38615, 1203, 4181, 606,
        4432, 1066, 262, 671, 4248, 421, 279, 1482, 5492, 374, 553, 59455, 26691, 624, 262, 421, 1482, 57102, 6112, 18073, 368, 961, 364, 68658, 36843, 3646, 286, 671, 7054, 279, 3681, 3754, 624
        , 286, 97723, 76453, 38925, 28545, 741, 1789, 286, 671, 5549, 279, 1482, 5492, 3890, 624, 286, 1482, 57102, 284, 1482, 57102, 6112, 7213, 262, 770, 510, 286, 1438, 271, 2, 8213, 279, 1590
        , 5492, 2265, 624, 11822, 57102, 6112, 284, 1482, 57102, 198, 1350, 955, 10022, 1590, 5492, 6342, 572, 11573, 11822, 57102, 6112, 11661, 1138, 13874, 19324, 641, 419, 6049, 2038, 11, 582,
        990, 279, 1565, 3600, 28545, 63, 729, 311, 3271, 311, 279, 1790, 3754, 1283, 42659, 279, 1482, 825, 13, 1096, 1616, 11, 582, 5978, 429, 582, 3060, 5619, 279, 3681, 13918, 3080, 582, 5545
        , 264, 5492, 553, 59455, 26691, 13, 151645, 198]

        response_loss_mask = [1] * len(response_ids)

        response_token_ids_idxs = []
        human_token_ids_idxs = []

        response_ids_np = np.array(response_ids)

        for assistant_idx in np.where(response_ids_np == self.response_template_ids[0])[0]:
            if (self.response_template_ids == response_ids_np[assistant_idx: assistant_idx + len(self.response_template_ids)].tolist()):
                response_token_ids_idxs.append(assistant_idx + len(self.response_template_ids))

        print(f'response_token_ids_idxs: {response_token_ids_idxs}')
        print(response_ids[response_token_ids_idxs[0]])

        for human_idx in np.where(response_ids_np == self.instruction_template_ids[0])[0]:
            if self.instruction_template_ids == response_ids_np[human_idx: human_idx + len(self.instruction_template_ids)].tolist():
                human_token_ids_idxs.append(human_idx)

        print(f'human_token_ids_idxs: {human_token_ids_idxs}')
        print(response_ids[human_token_ids_idxs[0]])

        if (
            len(human_token_ids_idxs) > 0
            and len(response_token_ids_idxs) > 0
            and human_token_ids_idxs[0] > response_token_ids_idxs[0]
        ):
            human_token_ids_idxs = [0] + human_token_ids_idxs

        for idx, (start, end) in enumerate(zip(human_token_ids_idxs, response_token_ids_idxs)):
            print(start, end)
            response_loss_mask[start:end] = [0] * (end-start)

        if len(response_token_ids_idxs) < len(human_token_ids_idxs):
            response_loss_mask[human_token_ids_idxs[-1]:] = [0] * (len(response_loss_mask)-human_token_ids_idxs[-1])

        print(response_loss_mask)

        
a = A()
a.a()
